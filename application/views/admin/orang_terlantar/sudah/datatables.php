<div class="d-none">
    <button type="button" class="detailModal" data-toggle="modal" data-target="#detailModal"></button>
</div>
<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Detail</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row w-25 mx-auto">
                    <div class="col">
                        <img class="img-fluid foto" alt="foto terlantar">
                    </div>
                </div>
                <div class="row verif">
                    <div class="col-4">
                        Bantuan Yang Diterima
                    </div>
                    <div class="col">
                        : <span class="verif-text"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Keterangan Admin
                    </div>
                    <div class="col">
                        : <span class="keterangan"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Jenis Orang Terlantar
                    </div>
                    <div class="col">
                        : <span class="jenis_orang_terlantar"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Alamat
                    </div>
                    <div class="col">
                        : <span class="terlantar_alamat"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        NIK
                    </div>
                    <div class="col">
                        : <span class="terlantar_nik"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        NO KK
                    </div>
                    <div class="col">
                        : <span class="terlantar_no_kk"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        NO DTKS / BDT
                    </div>
                    <div class="col">
                        : <span class="terlantar_no_dtks"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tempat, Tanggal Lahir
                    </div>
                    <div class="col">
                        : <span class="terlantar_tempat_lahir"></span>, <span class="terlantar_tanggal_lahir"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Jenis Kelamin
                    </div>
                    <div class="col">
                        : <span class="terlantar_jenis_kelamin"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Agama
                    </div>
                    <div class="col">
                        : <span class="agama"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        RT / RW
                    </div>
                    <div class="col">
                        : <span class="terlantar_rt"></span>/<span class="terlantar_rw"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Kecamatan
                    </div>
                    <div class="col">
                        : <span class="terlantar_kecamatan"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Kabupaten
                    </div>
                    <div class="col">
                        : <span class="terlantar_kabupaten"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        No Telp. (WA)
                    </div>
                    <div class="col">
                        : <span class="terlantar_telp"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tempat Tinggal
                    </div>
                    <div class="col">
                        : <span class="tempat_tinggal"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Kondisi Tempat Tinggal
                    </div>
                    <div class="col">
                        : <span class="kondisi_tempat_tinggal"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Kategori Orang Terlantar
                    </div>
                    <div class="col">
                        : <span class="kategori_ot"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Fasilitas Kesehatan
                    </div>
                    <div class="col">
                        : <span class="fasilitas_kesehatan"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Kondisi Orang Terlantar
                    </div>
                    <div class="col">
                        : <span class="kondisi_ot"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Kebutuhan Yang Diperlukan
                    </div>
                    <div class="col">
                        : <span class="kebutuhan_diperlukan"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Permasalahan Yang Dihadapi
                    </div>
                    <div class="col">
                        : <span class="alasan_terlantar"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tujuan Alamat
                    </div>
                    <div class="col">
                        : <span class="tujuan_alamat"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tujuan RT / RW
                    </div>
                    <div class="col">
                        : <span class="tujuan_rt"></span>/<span class="tujuan_rw"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tujuan Desa
                    </div>
                    <div class="col">
                        : <span class="tujuan_desa"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tujuan Kecamatan
                    </div>
                    <div class="col">
                        : <span class="tujuan_kecamatan"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tujuan Kabupaten
                    </div>
                    <div class="col">
                        : <span class="tujuan_kabupaten"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Tujuan Provinsi
                    </div>
                    <div class="col">
                        : <span class="tujuan_provinsi"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        Diajukan Pada
                    </div>
                    <div class="col">
                        : <span class="created_at"></span>
                    </div>
                </div>
                <div class="row status">
                    <div class="col-4">
                        Status
                    </div>
                    <div class="col">
                        : <span class="status-text"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    var id = null;
    var datas = [];
    var tabel = null;
    var start = null;
    var end = null;
    var date = null;
    var nama = "";
    var nik = "";
    var no_kk = "";
    var desa = "";
    var kecamatan = "";
    var kabupaten = "";
    var tempat_tinggal_id = "";
    var kondisi_tempat_tinggal_id = "";
    var kategori_ot_id = "";
    var fasilitas_kesehatan_id = "";
    var kondisi_ot_id = "";
    var kebutuhan_diperlukan_id = "";



    // function deleteData(id) {
    //     var cek = confirm('Yakin ingin menghapus data ini?');
    //     if (cek) {
    //         $('.deleteData').attr('action', "<?= base_url('admin/orangterlantar/delete/') ?>" + id)
    //         $('.deleteData').submit();
    //     }
    // }

    function tolakData(id) {
        var cek = confirm('Yakin ingin menolak data ini?');
        if (cek) {
            $('.tolakData').attr('action', "<?= base_url('admin/orangterlantar/tolak/') ?>" + id)
            $('.tolakData').submit();
        }
    }

    function verifData(id) {
        var cek = confirm('Yakin ingin memverifikasi data ini?');
        if (cek) {
            $('.verifData').attr('action', "<?= base_url('admin/orangterlantar/verif/') ?>" + id)
            $('.verifData').submit();
        }
    }

    function batalProses(id) {
        var cek = confirm('Yakin ingin membatalkan proses data ini?');
        if (cek) {
            $('.batalProses').attr('action', "<?= base_url('admin/orangterlantar/proses/') ?>" + id)
            $('.batalProses').submit();
        }
    }

    function showData(index) {
        $('.status').addClass('d-none');
        // $('.verif').addClass('d-none');
        $('.detailModal').click()
        var data = datas[index]
        $('.status').removeClass('d-none');
        var status = '<span class="badge badge-info"><i class="fa fa-fw fa-clock"></i> DiProses</span>'
        $('.status-text').html('Sedang Diproses')
        if (data.verif_id != null) {
            // $('.verif').removeClass('d-none');
            status = '<span class="badge badge-success"><i class="fa fa-fw fa-check"></i> Diverifikasi</span>'
            $('.status-text').html('Diverifikasi Oleh ' + data.admin_verif_nama + ' Pada ' + toLocaleDate(data.verif_at))
        }
        var verif_text = data.sumber_dana_lainnya + " " + data.bansos_lainnya;
        if (data.sumber_dana_id != null) {
            verif_text = data.sumber_dana_nama + ", " + data.bansos_nama + " " + formatRupiah(data.bansos_total, true)
        }
        $('.verif-text').html(verif_text)
        if (data.tolak_id != null) {
            status = '<span class="badge badge-danger"><i class="fa fa-fw fa-times"></i> Ditolak</span>'
            $('.status-text').html('Ditolak Oleh ' + data.admin_tolak_nama + ' Pada ' + toLocaleDate(data.tolak_at))
        }
        $('#detailModalLabel').html('Detail Orang Terlantar ' + data.terlantar_nama + " " + status)
        $('.foto').attr('src', "<?= base_url('uploads/') ?>" + data.foto)
        $('.jenis_orang_terlantar').html(data.orang_terlantar_nama)
        $('.terlantar_alamat').html(data.terlantar_alamat)
        $('.terlantar_nik').html(data.terlantar_nik)
        $('.terlantar_no_kk').html(data.terlantar_no_kk)
        $('.terlantar_no_dtks').html(data.terlantar_no_dtks)
        $('.terlantar_tempat_lahir').html(data.terlantar_tempat_lahir)
        $('.terlantar_tanggal_lahir').html(toLocaleDate(data.terlantar_tanggal_lahir))
        $('.terlantar_jenis_kelamin').html(data.terlantar_jenis_kelamin)
        $('.agama').html(data.agama_nama)
        $('.terlantar_rt').html(data.terlantar_rt)
        $('.terlantar_rw').html(data.terlantar_rw)
        $('.terlantar_kecamatan').html(data.terlantar_kecamatan)
        $('.terlantar_kabupaten').html(data.terlantar_kabupaten)
        $('.terlantar_telp').html(data.terlantar_telp)
        $('.tempat_tinggal').html(data.tempat_tinggal_nama)
        $('.kondisi_tempat_tinggal').html(data.kondisi_tempat_tinggal_nama)
        $('.kategori_ot').html(data.kategori_ot_nama)
        $('.fasilitas_kesehatan').html(data.fasilitas_kesehatan_nama)
        $('.kondisi_ot').html(data.kondisi_ot_nama)
        $('.kebutuhan_diperlukan').html(data.kebutuhan_diperlukan_nama)
        if (data.kebutuhan_diperlukan_id == null) {
            $('.kebutuhan_diperlukan').html(data.kebutuhan_diperlukan_lainnya)
        }
        $('.alasan_terlantar').html(data.alasan_terlantar)
        $('.tujuan_alamat').html(data.tujuan_alamat)
        $('.tujuan_rt').html(data.tujuan_rt)
        $('.tujuan_rw').html(data.tujuan_rw)
        $('.tujuan_desa').html(data.tujuan_desa)
        $('.tujuan_kecamatan').html(data.tujuan_kecamatan)
        $('.tujuan_kabupaten').html(data.tujuan_kabupaten)
        $('.tujuan_provinsi').html(data.tujuan_provinsi)
        $('.created_at').html(toLocaleDate(data.created_at))
    }
    $(document).ready(function() {
        tabel = $('#datatable').DataTable({
            "processing": true,
            "serverSide": true,
            "scrollX": true,
            "scrollY": "<?= $_datatable_scroll_y ?>",
            "scrollCollapse": true,
            "ordering": true, // Set true agar bisa di sorting
            "order": [
                [16, 'desc']
            ], // Default sortingnya berdasarkan kolom / field ke 0 (paling pertama)
            "searching": false,
            'columnDefs': [{
                "targets": [0, 17],
                "orderable": false
            }],
            "ajax": {
                "url": "<?= base_url(str_replace("/$_status/", "/", str_replace("_", "", $_datatable_view))) . "/" . $_id . "/" . $_status ?>", // URL file untuk proses select datanya
                "type": "POST",
                "data": function(d) {
                    d.date = date;
                    d.nama = nama;
                    d.nik = nik;
                    d.no_kk = no_kk;
                    d.desa = desa;
                    d.kecamatan = kecamatan;
                    d.kabupaten = kabupaten;
                    d.tempat_tinggal_id = tempat_tinggal_id;
                    d.kondisi_tempat_tinggal_id = kondisi_tempat_tinggal_id;
                    d.kategori_ot_id = kategori_ot_id;
                    d.fasilitas_kesehatan_id = fasilitas_kesehatan_id;
                    d.kondisi_ot_id = kondisi_ot_id;
                    d.kebutuhan_diperlukan_id = kebutuhan_diperlukan_id;
                }
            },
            "searching": false,
            "deferRender": true,
            "aLengthMenu": [
                [10, 50],
                [10, 50]
            ], // Combobox Limit
            "initComplete": function(settings, json) {
                datas = json.data
            },
            "columns": [{
                    'data': 'terlantar_id'
                },
                {
                    "data": "terlantar_nama"
                }, // Tampilkan nama
                {
                    "data": "terlantar_nik"
                },
                {
                    "data": "terlantar_no_kk"
                },
                {
                    "data": "terlantar_desa"
                },
                {
                    "data": "terlantar_kecamatan"
                },
                {
                    "data": "terlantar_kabupaten"
                },
                {
                    "data": "user_pendaftar_nama"
                },
                {
                    "data": "tempat_tinggal_nama"
                },
                {
                    "data": "kondisi_tempat_tinggal_nama",
                    "render": function(data, type, row) {
                        var html = row.kondisi_tempat_tinggal_nama;
                        if (row.kondisi_tempat_tinggal_id == null) {
                            html = "Tidak Ada"
                        }
                        return html
                    }
                },
                {
                    "data": "kategori_ot_nama"
                },
                {
                    "data": "fasilitas_kesehatan_nama"
                },
                {
                    "data": "kondisi_ot_nama"
                },
                {
                    "data": "kebutuhan_diperlukan_nama",
                    "render": function(data, type, row) {
                        var html = row.kebutuhan_diperlukan_nama;
                        if (row.kebutuhan_diperlukan_id == null) {
                            html = row.kebutuhan_diperlukan_lainnya
                        }
                        return html
                    }
                },
                {
                    "data": "admin_proses_nama",
                },
                {
                    "render": function(data, type, row) {
                        return toLocaleDate(row.proses_at)
                    }
                },
                {
                    "data": "created_at",
                    "render": function(data, type, row) {
                        return toLocaleDate(row.created_at)
                    }
                },
                {
                    "render": function(data, type, row, meta) { // Tampilkan kolom aksi
                        var html = '<button type="button" class="btn btn-sm float-left" onClick="showData(' + meta.row + ')"><div class="badge badge-info"><i class="fa fa-fw fa-eye"></i> Detail</div></button>'
                        html += '<form method="POST" class="batalProses float-left"><input type="hidden" name="batal"><button type="button" class="btn btn-sm" onClick="batalProses(' + row.terlantar_id + ')"><div class="badge badge-danger"><i class="fa fa-fw fa-times"></i> Batal Proses</div></form>'
                        html += '<form method="POST" class="verifData float-left"><button type="button" class="btn btn-sm" onClick="verifData(' + row.terlantar_id + ')"><div class="badge badge-success"><i class="fa fa-fw fa-check"></i> Verif</div></form>'
                        html += '<form method="POST" class="tolakData float-left"><button type="button" class="btn btn-sm" onClick="tolakData(' + row.terlantar_id + ')"><div class="badge badge-danger"><i class="fa fa-fw fa-times"></i> Tolak</div></form>'
                        // html += '<form method="POST" class="deleteData float-left"><button type="button" class="btn btn-sm" onClick="deleteData(' + row.terlantar_id + ')"><div class="badge badge-danger"><i class="fa fa-fw fa-trash"></i> Hapus</div></form>'
                        return html
                    }
                },
            ],
        });
        tabel.on('order.dt search.dt draw.dt', function() {
            tabel.column(0, {
                search: 'applied',
                order: 'applied'
            }).nodes().each(function(cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();
        $('.filtered').each(function(i) {
            var title = $(this).text();
            if (i == 1 || i == 2 || i == 3) {
                var input = $('<input class="form-control form-control-sm" type="text" placeholder="' + title + '"/>').appendTo($(this).empty());
                if (i == 2 || i == 3) {
                    var input = $('<input class="form-control form-control-sm" type="text" data-inputmask-alias="9" data-inputmask-repeat="16" placeholder="' + title + '"/>').appendTo($(this).empty());
                }
                input.on('keyup change clear', function() {
                    var term = $(this).val();
                    if (i == 1) {
                        nama = term;
                    }
                    if (i == 2) {
                        nik = term;
                    }
                    if (i == 3) {
                        no_kk = term;
                    }
                    tabel.ajax.reload(null, false)
                });
            } else if (i >= 4 && i <= 6 || i >= 8 && i <= 13) {
                var select = $('<select class="form-control form-control-sm"><option value="">-- Pilih ' + title + ' --</option></select>').appendTo($(this).empty()).on('change', function() {
                    var term = $(this).val();
                    if (i == 4) {
                        desa = term
                    }
                    if (i == 5) {
                        kecamatan = term
                    }
                    if (i == 6) {
                        kabupaten = term
                    }
                    if (i == 8) {
                        tempat_tinggal_id = term
                    }
                    if (i == 9) {
                        kondisi_tempat_tinggal_id = term
                    }
                    if (i == 10) {
                        kategori_ot_id = term
                    }
                    if (i == 11) {
                        fasilitas_kesehatan_id = term
                    }
                    if (i == 12) {
                        kondisi_ot_id = term
                    }
                    if (i == 13) {
                        kebutuhan_diperlukan_id = term
                    }
                    tabel.ajax.reload(null, true)
                });
                var options = []
                if (i == 4) {
                    options = <?= $_desas ?>;
                }
                if (i == 5) {
                    options = <?= $_kecamatans ?>;
                }
                if (i == 6) {
                    options = <?= $_kabupatens ?>;
                }
                if (i == 8) {
                    options = <?= $_tempat_tinggals ?>;
                }
                if (i == 9) {
                    options = <?= $_kondisi_tempat_tinggals ?>;
                }
                if (i == 10) {
                    options = <?= $_kategori_ots ?>;
                }
                if (i == 11) {
                    options = <?= $_fasilitas_kesehatans ?>;
                }
                if (i == 12) {
                    options = <?= $_kondisi_ots ?>;
                }
                if (i == 13) {
                    options = <?= $_kebutuhan_diperlukans ?>;
                }
                if (i >= 4 && i <= 6) {
                    options.map((d) => {
                        select.append('<option value="' + d.nama + '">' + d.nama + '</option>')
                    })
                } else {
                    options.map((d) => {
                        select.append('<option value="' + d.id + '">' + d.nama + '</option>')
                    })
                }
            } else if (i == 16) {
                var daterange = '<div id="reportrange" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%"><i class="fa fa-calendar"></i>&nbsp;<span></span> <i class="fa fa-caret-down"></i></div>';
                $(this).empty().append(daterange);
            } else {
                $(this).empty();
            }
        });

        function cb(start, end) {
            date = start.format('YYYY-MM-D') + '/' + end.format('YYYY-MM-D');
            $('.date-text').html("Data Dari tanggal " + start.format('D MMMM, YYYY') + ' - ' + end.format('D MMMM, YYYY'))
            tabel.ajax.reload(null, false)
        }

        $('#reportrange').daterangepicker({
            showDropdowns: true,
            autoApply: false,
            locale: {
                customRangeLabel: 'Tentukan Sendiri',
                cancelLabel: 'Batal',
                applyLabel: 'Pilih',
            },
            ranges: {
                'Hari ini': [moment(), moment()],
                'Kemarin': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                '7 Hari terakhir': [moment().subtract(6, 'days'), moment()],
                '30 Hari terakhir': [moment().subtract(29, 'days'), moment()],
                'Bulan ini': [moment().startOf('month'), moment().endOf('month')],
                'Bulan sebelumnya': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        });
        $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
            cb(picker.startDate, picker.endDate)
        })
        $('.refreshData').on('click', function() {
            date = null;
            $('.date-text').html("Semua Data");
            tabel.ajax.reload(null, false)
        })
    });
</script>